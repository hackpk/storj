<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="1589px" preserveAspectRatio="none" style="width:1233px;height:1589px;background:#FFFFFF;" version="1.1" viewBox="0 0 1233 1589" width="1233px" zoomAndPan="magnify"><defs/><g><rect height="968.9766" style="stroke:#000000;stroke-width:1.5;fill:none;" width="1217" x="10" y="286.3594"/><rect height="133.6641" style="stroke:#000000;stroke-width:1.5;fill:none;" width="457" x="582.5" y="732.5469"/><rect height="133.6641" style="stroke:#000000;stroke-width:1.5;fill:none;" width="457" x="582.5" y="880.2109"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="55" x2="55" y1="40.2969" y2="1549.9297"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="440" x2="440" y1="40.2969" y2="1549.9297"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="620.5" x2="620.5" y1="40.2969" y2="1549.9297"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="868.5" x2="868.5" y1="40.2969" y2="1549.9297"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="970.5" x2="970.5" y1="40.2969" y2="1549.9297"/><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="71" x="20" y="9"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="57" x="27" y="28.9951">S3Client</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="71" x="20" y="1548.9297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="57" x="27" y="1568.9248">S3Client</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="73" x="404" y="9"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="59" x="411" y="28.9951">Gateway</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="73" x="404" y="1548.9297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="59" x="411" y="1568.9248">Gateway</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="56" x="592.5" y="9"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="42" x="599.5" y="28.9951">Uplink</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="56" x="592.5" y="1548.9297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="42" x="599.5" y="1568.9248">Uplink</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="68" x="834.5" y="9"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="54" x="841.5" y="28.9951">Satellite</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="68" x="834.5" y="1548.9297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="54" x="841.5" y="1568.9248">Satellite</text><rect fill="#E2E2F0" height="30.2969" style="stroke:#181818;stroke-width:0.5;" width="113" x="916.5" y="5"/><rect fill="#E2E2F0" height="30.2969" style="stroke:#181818;stroke-width:0.5;" width="113" x="912.5" y="9"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="99" x="919.5" y="28.9951">StorageNodes</text><rect fill="#E2E2F0" height="30.2969" style="stroke:#181818;stroke-width:0.5;" width="113" x="916.5" y="1548.9297"/><rect fill="#E2E2F0" height="30.2969" style="stroke:#181818;stroke-width:0.5;" width="113" x="912.5" y="1552.9297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="99" x="919.5" y="1572.9248">StorageNodes</text><polygon fill="#181818" points="428.5,67.4297,438.5,71.4297,428.5,75.4297,432.5,71.4297" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="55.5" x2="434.5" y1="71.4297" y2="71.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="165" x="62.5" y="66.3638">PUT /bucket/dest?uploads</text><polygon fill="#181818" points="608.5,114.6953,618.5,118.6953,608.5,122.6953,612.5,118.6953" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="440.5" x2="614.5" y1="118.6953" y2="118.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="153" x="447.5" y="113.6294">BeginUpload (multipart)</text><path d="M368,84.4297 L368,139.4297 L435,139.4297 L435,94.4297 L425,84.4297 L368,84.4297 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M425,84.4297 L425,94.4297 L435,94.4297 L425,84.4297 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="44" x="374" y="101.4966">Bucket</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="23" x="374" y="116.6294">Key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="374" y="131.7622">Expires</text><polygon fill="#181818" points="856.5,161.9609,866.5,165.9609,856.5,169.9609,860.5,165.9609" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="620.5" x2="862.5" y1="165.9609" y2="165.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="627.5" y="160.895">BeginObjectRequest</text><polygon fill="#181818" points="631.5,194.0938,621.5,198.0938,631.5,202.0938,627.5,198.0938" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="625.5" x2="867.5" y1="198.0938" y2="198.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="139" x="637.5" y="193.0278">BeginObjectResponse</text><path d="M873,178.9609 L873,203.9609 L955,203.9609 L955,188.9609 L945,178.9609 L873,178.9609 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M945,178.9609 L945,188.9609 L955,188.9609 L945,178.9609 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="61" x="879" y="196.0278">StreamID</text><polygon fill="#181818" points="451.5,229.2266,441.5,233.2266,451.5,237.2266,447.5,233.2266" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="445.5" x2="619.5" y1="233.2266" y2="233.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="124" x="457.5" y="228.1606">BeginUpload return</text><path d="M625,214.0938 L625,239.0938 L707,239.0938 L707,224.0938 L697,214.0938 L625,214.0938 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M697,214.0938 L697,224.0938 L707,224.0938 L697,214.0938 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="61" x="631" y="231.1606">StreamID</text><polygon fill="#181818" points="66.5,264.3594,56.5,268.3594,66.5,272.3594,62.5,268.3594" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="60.5" x2="439.5" y1="268.3594" y2="268.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="87" x="72.5" y="263.2935">200 response</text><path d="M445,249.2266 L445,274.2266 L552,274.2266 L552,259.2266 L542,249.2266 L445,249.2266 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M542,249.2266 L542,259.2266 L552,259.2266 L542,249.2266 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="86" x="451" y="266.2935">&lt;UploadId /&gt;</text><path d="M10,286.3594 L194,286.3594 L194,293.4922 L184,303.4922 L10,303.4922 L10,286.3594 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="968.9766" style="stroke:#000000;stroke-width:1.5;" width="1217" x="10" y="286.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="25" y="299.4263">loop for every part</text><polygon fill="#181818" points="428.5,350.8906,438.5,354.8906,428.5,358.8906,432.5,354.8906" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="55.5" x2="434.5" y1="354.8906" y2="354.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="361" x="62.5" y="319.5591">PUT /bucket/dest?partNumber=1&amp;uploadId=7tKsLOJgNs</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="225" x="62.5" y="334.6919">x-amz-copy-source: /bucket/source</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="308" x="62.5" y="349.8247">x-amz-copy-source-range:bytes=0-5368709120</text><polygon fill="#181818" points="608.5,428.4219,618.5,432.4219,608.5,436.4219,612.5,432.4219" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="440.5" x2="614.5" y1="432.4219" y2="432.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="113" x="447.5" y="427.356">CopyObjectRange</text><path d="M325,367.8906 L325,482.8906 L435,482.8906 L435,377.8906 L425,367.8906 L325,367.8906 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M425,367.8906 L425,377.8906 L435,377.8906 L425,367.8906 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="331" y="384.9575">UploadID</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="51" x="331" y="400.0903">Bucket?</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="30" x="331" y="415.2231">Key?</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="89" x="331" y="430.356">SourceBucket</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="68" x="331" y="445.4888">SourceKey</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="70" x="331" y="460.6216">StartOffset</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="62" x="331" y="475.7544">EndOffset</text><polygon fill="#181818" points="856.5,602.75,866.5,606.75,856.5,610.75,860.5,606.75" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="620.5" x2="862.5" y1="606.75" y2="606.75"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="627.5" y="601.6841">BeginCopyObjectRangeRequest</text><path d="M436,493.8203 L436,608.8203 L615,608.8203 L615,503.8203 L605,493.8203 L436,493.8203 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M605,493.8203 L605,503.8203 L615,503.8203 L605,493.8203 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="61" x="442" y="510.8872">StreamID</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="51" x="442" y="526.02">Bucket?</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="30" x="442" y="541.1528">Key?</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="89" x="442" y="556.2856">SourceBucket</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="65" x="535" y="556.2856">encrypted</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="68" x="442" y="571.4185">SourceKey</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="65" x="514" y="571.4185">encrypted</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="70" x="442" y="586.5513">StartOffset</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="62" x="442" y="601.6841">EndOffset</text><path d="M873,501.3867 L873,601.3867 L1212,601.3867 L1212,511.3867 L1202,501.3867 L873,501.3867 " fill="#90EE90" style="stroke:#181818;stroke-width:0.5;"/><path d="M1202,501.3867 L1202,511.3867 L1212,511.3867 L1202,501.3867 " fill="#90EE90" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="243" x="879" y="518.4536">Disallow combining objects: verify that</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="269" x="879" y="533.5864">all copy sources have the same streamID.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="879" y="548.7192"> </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="256" x="879" y="563.8521">Calculate on Satellite if offsets align with</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="318" x="879" y="578.9849">segment boundries: if unaligned send OrderLimits</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="242" x="879" y="594.1177">so Uplink can download and re-upload</text><polygon fill="#181818" points="631.5,672.7148,621.5,676.7148,631.5,680.7148,627.5,676.7148" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="625.5" x2="867.5" y1="676.7148" y2="676.7148"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="211" x="637.5" y="671.6489">BeginCopyObjectRangeResponse</text><path d="M873,619.75 L873,719.75 L1077,719.75 L1077,629.75 L1067,619.75 L873,619.75 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1067,619.75 L1067,629.75 L1077,629.75 L1067,619.75 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="89" x="879" y="636.8169">SegmentKeys</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="65" x="972" y="636.8169">encrypted</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="77" x="879" y="651.9497">if unaligned:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="183" x="879" y="667.0825">SegmentDownloadResponse</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="879" y="682.2153">SegmentBeginResponse</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="183" x="879" y="697.3481">SegmentDownloadResponse</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="879" y="712.481">SegmentBeginResponse</text><path d="M582.5,732.5469 L820.5,732.5469 L820.5,739.6797 L810.5,749.6797 L582.5,749.6797 L582.5,732.5469 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="133.6641" style="stroke:#000000;stroke-width:1.5;" width="457" x="582.5" y="732.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="193" x="597.5" y="745.6138">if first segment unaligned</text><polygon fill="#181818" points="959,766.8125,969,770.8125,959,774.8125,963,770.8125" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="620.5" x2="965" y1="770.8125" y2="770.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="148" x="627.5" y="765.7466">PieceDownloadRequest</text><polygon fill="#181818" points="631.5,795.9453,621.5,799.9453,631.5,803.9453,627.5,799.9453" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="625.5" x2="970" y1="799.9453" y2="799.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="637.5" y="794.8794">PieceDownloadResponse</text><polygon fill="#181818" points="959,825.0781,969,829.0781,959,833.0781,963,829.0781" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="620.5" x2="965" y1="829.0781" y2="829.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="627.5" y="824.0122">PieceUploadRequest</text><polygon fill="#181818" points="631.5,854.2109,621.5,858.2109,631.5,862.2109,627.5,858.2109" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="625.5" x2="970" y1="858.2109" y2="858.2109"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="141" x="637.5" y="853.145">PieceUploadResponse</text><path d="M582.5,880.2109 L817.5,880.2109 L817.5,887.3438 L807.5,897.3438 L582.5,897.3438 L582.5,880.2109 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="133.6641" style="stroke:#000000;stroke-width:1.5;" width="457" x="582.5" y="880.2109"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="190" x="597.5" y="893.2778">if last segment unaligned</text><polygon fill="#181818" points="959,914.4766,969,918.4766,959,922.4766,963,918.4766" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="620.5" x2="965" y1="918.4766" y2="918.4766"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="148" x="627.5" y="913.4106">PieceDownloadRequest</text><polygon fill="#181818" points="631.5,943.6094,621.5,947.6094,631.5,951.6094,627.5,947.6094" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="625.5" x2="970" y1="947.6094" y2="947.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="637.5" y="942.5435">PieceDownloadResponse</text><polygon fill="#181818" points="959,972.7422,969,976.7422,959,980.7422,963,976.7422" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="620.5" x2="965" y1="976.7422" y2="976.7422"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="627.5" y="971.6763">PieceUploadRequest</text><polygon fill="#181818" points="631.5,1001.875,621.5,1005.875,631.5,1009.875,627.5,1005.875" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="625.5" x2="970" y1="1005.875" y2="1005.875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="141" x="637.5" y="1000.8091">PieceUploadResponse</text><polygon fill="#181818" points="856.5,1071.2734,866.5,1075.2734,856.5,1079.2734,860.5,1075.2734" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="620.5" x2="862.5" y1="1075.2734" y2="1075.2734"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="627.5" y="1070.2075">FinishCopyObjectRangeRequest</text><path d="M408,1025.875 L408,1110.875 L615,1110.875 L615,1035.875 L605,1025.875 L408,1025.875 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M605,1025.875 L605,1035.875 L615,1035.875 L605,1025.875 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="89" x="414" y="1042.9419">SegmentKeys</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="65" x="507" y="1042.9419">encrypted</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="162" x="414" y="1058.0747">SegmentCommitRequest</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="186" x="414" y="1073.2075">| SegmentMakeInlineRequest</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="162" x="414" y="1088.3403">SegmentCommitRequest</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="186" x="414" y="1103.4731">| SegmentMakeInlineRequest</text><polygon fill="#181818" points="631.5,1159.3711,621.5,1163.3711,631.5,1167.3711,627.5,1163.3711" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="625.5" x2="867.5" y1="1163.3711" y2="1163.3711"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="224" x="637.5" y="1158.3052">FinishCopyObjectRangeResponmse</text><path d="M873,1121.5391 L873,1191.5391 L1090,1191.5391 L1090,1131.5391 L1080,1121.5391 L873,1121.5391 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1080,1121.5391 L1080,1131.5391 L1090,1131.5391 L1080,1121.5391 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="168" x="879" y="1138.606">SegmentSuccessfulPieces</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="196" x="879" y="1153.7388">| SegmentMakeInlineResponse</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="168" x="879" y="1168.8716">SegmentSuccessfulPieces</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="196" x="879" y="1184.0044">| SegmentMakeInlineResponse</text><polygon fill="#181818" points="451.5,1214.2031,441.5,1218.2031,451.5,1222.2031,447.5,1218.2031" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="445.5" x2="619.5" y1="1218.2031" y2="1218.2031"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="457.5" y="1213.1372">CopyObjectRange return</text><polygon fill="#181818" points="66.5,1243.3359,56.5,1247.3359,66.5,1251.3359,62.5,1247.3359" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="60.5" x2="439.5" y1="1247.3359" y2="1247.3359"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="87" x="72.5" y="1242.27">200 response</text><polygon fill="#181818" points="428.5,1279.4688,438.5,1283.4688,428.5,1287.4688,432.5,1283.4688" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="55.5" x2="434.5" y1="1283.4688" y2="1283.4688"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="262" x="62.5" y="1278.4028">POST /bucket/dest?uploadId=7tKsLOJgNs</text><polygon fill="#181818" points="608.5,1334.3008,618.5,1338.3008,608.5,1342.3008,612.5,1338.3008" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="440.5" x2="614.5" y1="1338.3008" y2="1338.3008"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96" x="447.5" y="1333.2349">CommitUpload</text><path d="M303,1296.4688 L303,1366.4688 L435,1366.4688 L435,1306.4688 L425,1296.4688 L303,1296.4688 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M425,1296.4688 L425,1306.4688 L435,1306.4688 L425,1296.4688 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="44" x="309" y="1313.5356">Bucket</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="23" x="309" y="1328.6685">Key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="309" y="1343.8013">UploadID</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="309" y="1358.9341">CustomMetadata</text><polygon fill="#181818" points="856.5,1440.5313,866.5,1444.5313,856.5,1448.5313,860.5,1444.5313" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="620.5" x2="862.5" y1="1444.5313" y2="1444.5313"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="144" x="627.5" y="1439.4653">ObjectCommitRequest</text><path d="M419,1392.1328 L419,1432.1328 L615,1432.1328 L615,1402.1328 L605,1392.1328 L419,1392.1328 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M605,1392.1328 L605,1402.1328 L615,1402.1328 L605,1392.1328 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="61" x="425" y="1409.1997">StreamID</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="425" y="1424.3325">CustomMetadata</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="60" x="540" y="1424.3325">encypted</text><path d="M873,1377 L873,1447 L1068,1447 L1068,1387 L1058,1377 L873,1377 " fill="#90EE90" style="stroke:#181818;stroke-width:0.5;"/><path d="M1058,1377 L1058,1387 L1068,1387 L1058,1377 " fill="#90EE90" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="144" x="879" y="1394.0669">Verify segment offsets</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="879" y="1409.1997"> </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="170" x="879" y="1424.3325">Change object status from</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="142" x="879" y="1439.4653">pending to committed</text><polygon fill="#181818" points="631.5,1469.6641,621.5,1473.6641,631.5,1477.6641,627.5,1473.6641" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="625.5" x2="867.5" y1="1473.6641" y2="1473.6641"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="637.5" y="1468.5981">ObjectCommitResponse</text><polygon fill="#181818" points="451.5,1498.7969,441.5,1502.7969,451.5,1506.7969,447.5,1502.7969" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="445.5" x2="619.5" y1="1502.7969" y2="1502.7969"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="139" x="457.5" y="1497.731">CommitUpload return</text><polygon fill="#181818" points="66.5,1527.9297,56.5,1531.9297,66.5,1535.9297,62.5,1531.9297" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="60.5" x2="439.5" y1="1531.9297" y2="1531.9297"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="87" x="72.5" y="1526.8638">200 response</text><!--MD5=[2693d91a734f68724a6ccebd27db7058]
@startuml

S3Client -> Gateway: PUT /bucket/dest?uploads

Gateway -> Uplink: BeginUpload (multipart)
note left
    Bucket
    Key
    Expires
end note

Uplink -> Satellite: BeginObjectRequest

Uplink <- - Satellite: BeginObjectResponse
note right
    StreamID
end note

Gateway <- - Uplink: BeginUpload return
note right
    StreamID
end note

S3Client <- - Gateway: 200 response
note right
    <UploadId />
end note

group loop for every part
    S3Client -> Gateway: PUT /bucket/dest?partNumber=1&uploadId=7tKsLOJgNs\nx-amz-copy-source: /bucket/source\nx-amz-copy-source-range:bytes=0-5368709120

    Gateway -> Uplink: CopyObjectRange
    note left
        UploadID
        Bucket?
        Key?
        SourceBucket
        SourceKey
        StartOffset
        EndOffset
    end note

    Uplink -> Satellite: BeginCopyObjectRangeRequest
    note left
        StreamID
        Bucket?
        Key?
        SourceBucket //encrypted//
        SourceKey //encrypted//
        StartOffset
        EndOffset
    end note
    note right #lightgreen
        Disallow combining objects: verify that 
        all copy sources have the same streamID.

        Calculate on Satellite if offsets align with
        segment boundries: if unaligned send OrderLimits
        so Uplink can download and re-upload
    end note

    Uplink <- - Satellite: BeginCopyObjectRangeResponse
    note right
        SegmentKeys //encrypted//
        //if unaligned://
        SegmentDownloadResponse
        SegmentBeginResponse
        SegmentDownloadResponse
        SegmentBeginResponse
    end note

    collections StorageNodes

    group if first segment unaligned
        Uplink -> StorageNodes: PieceDownloadRequest
        Uplink <- - StorageNodes: PieceDownloadResponse
        Uplink -> StorageNodes: PieceUploadRequest
        Uplink <- - StorageNodes: PieceUploadResponse
    end

    group if last segment unaligned
        Uplink -> StorageNodes: PieceDownloadRequest
        Uplink <- - StorageNodes: PieceDownloadResponse
        Uplink -> StorageNodes: PieceUploadRequest
        Uplink <- - StorageNodes: PieceUploadResponse
    end

    Uplink -> Satellite: FinishCopyObjectRangeRequest
    note left
        SegmentKeys //encrypted//
        SegmentCommitRequest
        | SegmentMakeInlineRequest
        SegmentCommitRequest
        | SegmentMakeInlineRequest
    end note

    Uplink <- - Satellite: FinishCopyObjectRangeResponmse
    note right
        SegmentSuccessfulPieces
        | SegmentMakeInlineResponse
        SegmentSuccessfulPieces
        | SegmentMakeInlineResponse
    end note

    Gateway <- - Uplink: CopyObjectRange return

    S3Client <- - Gateway: 200 response
end

S3Client -> Gateway: POST /bucket/dest?uploadId=7tKsLOJgNs

Gateway -> Uplink: CommitUpload
note left
    Bucket
    Key
    UploadID
    CustomMetadata
end note

Uplink -> Satellite: ObjectCommitRequest
note left
    StreamID
    CustomMetadata //encypted//
end note
note right #lightgreen
    Verify segment offsets

    Change object status from 
    pending to committed
end note

Uplink <- - Satellite: ObjectCommitResponse

Gateway <- - Uplink: CommitUpload return

S3Client <- - Gateway: 200 response

@enduml

PlantUML version 1.2022.4(Sat Apr 09 15:29:17 CEST 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: IE
--></g></svg>